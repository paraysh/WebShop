@using WebShop.Helper;

@model IEnumerable<WebShop.Models.OrderModel>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var ownOrders = Model.Where(x => x.OrderedBy == ViewBag.UserId).ToList();
    var empOrder = Model.Except(Model.Where(x => x.OrderedBy == ViewBag.UserId)).ToList();

    WebGrid webGridOwn = new WebGrid(source: ownOrders, canSort: false, canPage: false);
    WebGrid webGridEmp = new WebGrid(source: empOrder, canSort: false, canPage: false);
}

<style type="text/css">
    body {
        font-family: Arial;
        font-size: 10pt;
    }

    .Grid {
        border: 1px solid #ccc;
        border-collapse: collapse;
        /*background-color: #fff;*/
    }

        .Grid th {
            /*background-color: #B8DBFD;*/
            color: #333;
            font-weight: bold;
        }

        .Grid th, .Grid td {
            padding: 5px;
            border: 1px solid #ccc;
        }

        .Grid img {
            cursor: pointer;
        }

    .ChildGrid {
        width: 100%;
    }

        .ChildGrid th {
            /*background-color: #6C6C6C;*/
            /*color: #fff;*/
            color: #333;
            font-weight: bold;
        }

    .grid-header {
        background: lightblue;
    }
</style>

<script src="~/Scripts/WebGridFilter.js"></script>

<h2>Bestellverlauf</h2>

<ul class="nav nav-tabs">
    <li class="active"><a data-toggle="tab" href="#own">Eigene Bestellungen</a></li>
    <li><a data-toggle="tab" href="#employee">Mitarbeiterbestellungen</a></li>
</ul>

<div class="tab-content">
    <div id="own" class="tab-pane fade in active">
        <h3>Eigene Bestellungen</h3>
        @webGridOwn.GetHtml(
        htmlAttributes: new { @id = "WebGrid", @class = "table table-bordered table-striped table-condensed" },
        headerStyle: "grid-header",
        columns: webGridOwn.Columns(
                 webGridOwn.Column(null, null, format: @<text>
                        <img src="~/Content/Images/plus.png" /><div style="display:none"></div></text>),
                        webGridOwn.Column("OrderId", "Bestell-ID"),
                        webGridOwn.Column("OrderDt", "Bestelldatum"),
                        webGridOwn.Column("OrderedByName", "Bestellt von"),
                        webGridOwn.Column("OrderStatus", "Bestellstatus"),
                        webGridOwn.Column("TotalItems", "Artikelanzahl"),
                        webGridOwn.Column("TotalCost", "Gesamtbetrag"),
                        webGridOwn.Column("Prüfen", format: (item) =>
                        {
                        if (item.OrderApproved == "N" && ViewBag.UserRole == (int)WebShop.Models.Enum.UserRoleEnum.TeamLeaders)
                        {

                        return Html.Raw(string.Format("<text><a href=\"#\" id=\"Approve_{0}\" class=\"approve btn btn-success\">Genehmigen</a></text>", item.Id)
                        + "  " + string.Format("<text><a href=\"#\" id=\"Reject_{0}\" class=\"reject btn btn-danger\">Ablehnen</a></text>", item.Id));
                        }
                        else
                        {
                        return "-";
                        }

                        }),
                        webGridOwn.Column(format: (item) =>
                        {
                        WebGrid childGrid = new WebGrid(source: item.lstOrderDetails, canSort: false, canPage: false);
                        return childGrid.GetHtml(
                        htmlAttributes: new { @class = "ChildGrid table table-bordered table-striped table-condensed" },
                        headerStyle: "grid-header",
                        columns: childGrid.Columns(
                        childGrid.Column("ItemName", "Artikelname"),
                        childGrid.Column("SerialNo", "Seriennummer"),
                        childGrid.Column("LendingPeriodMonths", "Leihdauer (Monate)"),
                        childGrid.Column("LendingStartDt", "Leihbeginn"),
                        childGrid.Column("LendingEndDt", "Leihrückgabe")
                        ));
                        })
                        ))
    </div>
    <div id="employee" class="tab-pane fade">
        <h3>Mitarbeiterbestellungen</h3>
        <p>Filtern durch klicken auf "Bestellt von"</p>
        @*@webGridEmp.GetHtml(
            htmlAttributes: new { @id = "WebGrid", @class = "table table-bordered table-striped table-condensed" },
            headerStyle: "grid-header",
            columns: webGridEmp.Columns(
                     webGridEmp.Column(null, null, format: @<text>
                            <img src="~/Content/Images/plus.png" /><div style="display:none"></div></text>),
                                webGridEmp.Column("OrderId", "Bestell-ID"),
                                webGridEmp.Column("OrderDt", "Bestelldatum"),
                                webGridEmp.Column("OrderedByName", "Bestellt von"),
                                webGridEmp.Column("OrderStatus", "Bestellstatus"),
                                webGridEmp.Column("TotalItems", "Artikelanzahl"),
                                webGridEmp.Column("TotalCost", "Gesamtbetrag"),
                                webGridEmp.Column("Prüfen", format: (item) =>
                                {
                                if (item.OrderApproved == "N" && ViewBag.UserRole == (int)WebShop.Models.Enum.UserRoleEnum.TeamLeaders)
                                {

                                return Html.Raw(string.Format("<text><a href=\"#\" id=\"Approve_{0}\" class=\"approve btn btn-success\">Genehmigen</a></text>", item.Id)
                                + "  " + string.Format("<text><a href=\"#\" id=\"Reject_{0}\" class=\"reject btn btn-danger\">Ablehnen</a></text>", item.Id));
                                }
                                else
                                {
                                return "-";
                                }

                                }),
                                webGridEmp.Column(format: (item) =>
                                {
                                WebGrid childGrid = new WebGrid(source: item.lstOrderDetails, canSort: false, canPage: false);
                                return childGrid.GetHtml(
                                htmlAttributes: new { @class = "ChildGrid table table-bordered table-striped table-condensed" },
                                headerStyle: "grid-header",
                                columns: childGrid.Columns(
                                childGrid.Column("ItemName", "Artikelname"),
                                childGrid.Column("SerialNo", "Seriennummer"),
                                childGrid.Column("LendingPeriodMonths", "Leihdauer (Monate)"),
                                childGrid.Column("LendingStartDt", "Leihbeginn"),
                                childGrid.Column("LendingEndDt", "Leihrückgabe")
                                ));
                                })
                                ))*@




            @MvcHtmlString.Create(
                webGridEmp.GetHtml(
                    htmlAttributes: new
                    {
                        @id = "WebGridEmp",
                        @class = "table table-bordered table-striped table-condensed"
                    },
                    emptyRowCellValue: "No Records Found",
                    headerStyle: "grid-header",
                    columns:  webGridEmp.Columns(
                     webGridEmp.Column(null, null, format: @<text>
                            <img src="~/Content/Images/plus.png" /><div style="display:none"></div></text>),
                                webGridEmp.Column("OrderId", "Bestell-ID"),
                                webGridEmp.Column("OrderDt", "Bestelldatum"),
                                webGridEmp.Column("OrderedByName", "{UserName-filter}"), //"Bestellt von"
                                webGridEmp.Column("OrderStatus", "Bestellstatus"),
                                webGridEmp.Column("TotalItems", "Artikelanzahl"),
                                webGridEmp.Column("TotalCost", "Gesamtbetrag"),
                                webGridEmp.Column("Prüfen", format: (item) =>
                                {
                                    if (item.OrderApproved == "N" && ViewBag.UserRole == (int)WebShop.Models.Enum.UserRoleEnum.TeamLeaders)
                                    {

                                        return Html.Raw(string.Format("<text><a href=\"#\" id=\"Approve_{0}\" class=\"approve btn btn-success\">Genehmigen</a></text>", item.Id)
                                        + "  " + string.Format("<text><a href=\"#\" id=\"Reject_{0}\" class=\"reject btn btn-danger\">Ablehnen</a></text>", item.Id));
                                    }
                                    else
                                    {
                                        return "-";
                                    }

                                }),
                                webGridEmp.Column(format: (item) =>
                                {
                                    WebGrid childGrid = new WebGrid(source: item.lstOrderDetails, canSort: false, canPage: false);
                                    return childGrid.GetHtml(
                                    htmlAttributes: new { @class = "ChildGrid table table-bordered table-striped table-condensed" },
                                    headerStyle: "grid-header",
                                    columns: childGrid.Columns(
                                    childGrid.Column("ItemName", "Artikelname"),
                                    childGrid.Column("SerialNo", "Seriennummer"),
                                    childGrid.Column("LendingPeriodMonths", "Leihdauer (Monate)"),
                                    childGrid.Column("LendingStartDt", "Leihbeginn"),
                                    childGrid.Column("LendingEndDt", "Leihrückgabe")
                                    ));
                                })
                        ))
                        .ToString()
                        .Replace("{UserName-filter}", Html.WebGridFilter<WebShop.Models.OrderModel>(Model, e => e.OrderedByName, "Bestellt von").ToString()))
    </div>
</div>




<script type="text/javascript">
    $(function () {
        //Loop through all Child Grids.
        $("#WebGrid .ChildGrid").each(function () {
            console.log('test');
            //Copy the Child Grid to DIV.
            var childGrid = $(this).clone();
            $(this).closest("TR").find("TD").eq(0).find("DIV").append(childGrid);

            //Remove the Last Column from the Row.
            $(this).parent().remove();
        });

        //Remove Last Column from Header Row.
        $("#WebGrid TH:last-child").eq(0).remove();

        //Loop through all Child Grids.
        $("#WebGridEmp .ChildGrid").each(function () {
            console.log('test');
            //Copy the Child Grid to DIV.
            var childGrid = $(this).clone();
            $(this).closest("TR").find("TD").eq(0).find("DIV").append(childGrid);

            //Remove the Last Column from the Row.
            $(this).parent().remove();
        });

        //Remove Last Column from Header Row.
        $("#WebGridEmp TH:last-child").eq(0).remove();


    });
    //Assign Click event to Plus Image.
    $("body").on("click", "img[src*='plus.png']", function () {
        $(this).closest("tr").after("<tr><td></td><td colspan = '999'>" + $(this).next().html() + "</td></tr>");
        $(this).attr("src", "/Content/images/minus.png");
    });
    //Assign Click event to Minus Image.
    $("body").on("click", "img[src*='minus.png']", function () {
        $(this).attr("src", "/Content/images/plus.png");
        $(this).closest("tr").next().remove();
    });

    //Approve Clicked
    $(".approve").on("click", function () {
        var orderId = $(this).attr("id").split("_")[1];
        var formData = new FormData();
        formData.append("OrderId", orderId);

        $.ajax({
            async: true,
            type: 'POST',
            contentType: false,
            processData: false,
            data: formData,
            url: '/Order/Approve',
            success: function (data) {
                if (data.Success) {
                    ShowAlert('Success', data.Message, 'success');
                    location.reload();
                }
                if (data.Error) {
                    //alert(data.Message);
                    ShowAlert('Error', data.Message, 'danger');
                }
            },
            error: function () {
                alert("Something went wrong!");
            }
        });
    });

    //Reject Clicked
    $(".reject").on("click", function () {
        var orderId = $(this).attr("id").split("_")[1];
        var formData = new FormData();
        formData.append("OrderId", orderId);

        $.ajax({
            async: true,
            type: 'POST',
            contentType: false,
            processData: false,
            data: formData,
            url: '/Order/Reject',
            success: function (data) {
                if (data.Success) {
                    ShowAlert('Success', data.Message, 'success');
                    //alert(data.Message);
                    location.reload();
                }
            },
            error: function () {
                alert("Something went wrong!");
            }
        });
    });

</script>

